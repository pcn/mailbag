#!/bin/bash

set -e -x -o pipefail

# Create empty esmtpaccess file if it doesn't exist
touch /etc/courier/esmtpaccess
/usr/lib/courier/sbin/makesmtpaccess
/usr/sbin/makeuserdb

/usr/sbin/authdaemond start

# Certificates are now mounted directly from cert-manager secrets at /certs/
# No need to copy or create certificate files - Courier uses them directly

# start the imapd-ssl and keep container alive
/usr/lib/courier/sbin/imapd-ssl start

# Keep container alive by monitoring the service
while true; do
    if ! pgrep -f imapd-ssl > /dev/null; then
        echo "imapd-ssl stopped, restarting..."
        /usr/lib/courier/sbin/imapd-ssl start
    fi
    sleep 10
done
