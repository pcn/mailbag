#!/bin/bash

set -e -x -o pipefail

# context.json is added via the docker/container as a bind mount
/render-template --context /context.json --template /acceptmailfor.template > /etc/courier/esmtpacceptmailfor.dir/context
/render-template --context /context.json --template /hosteddomains.template > /etc/courier/hosteddomains

/usr/lib/courier/share/makehosteddomains
# Create empty esmtpaccess file if it doesn't exist
touch /etc/courier/esmtpaccess
/usr/lib/courier/sbin/makesmtpaccess
/usr/sbin/makeuserdb

/usr/sbin/authdaemond start

( cd /usr/lib/courier/share;
  cat esmtpd_cert.pem esmtpd_private_key.pem >> esmtpd.pem ; 
  chmod 400 esmtpd.pem;
  chown daemon esmtpd.pem
)

# start the msa (courierd runs in separate container)
/usr/lib/courier/sbin/esmtpd-msa start
