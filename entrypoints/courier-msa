#!/bin/bash

set -e -x -o pipefail

# context.json is added via the docker/container as a bind mount
/render-template --context /context.json --template /acceptmailfor.template > /etc/courier/esmtpacceptmailfor.dir/context
/render-template --context /context.json --template /hosteddomains.template > /etc/courier/hosteddomains
/render-template --context /context.json --template /esmtpd-base-msa.template > /etc/courier/esmtpd
/render-template --context /context.json --template /esmtpd-msa.template > /etc/courier/esmtpd-msa

/usr/lib/courier/share/makehosteddomains
# Create smtpaccess directory and generate default access file from template
mkdir -p /etc/courier/smtpaccess
/render-template --context /context.json --template /smtpaccess-default.template > /etc/courier/smtpaccess/default
/usr/lib/courier/sbin/makesmtpaccess
/usr/sbin/makeuserdb

/usr/sbin/authdaemond start

# Create combined esmtpd.pem from mounted certificate files
( cd /usr/lib/courier/share;
  if [ -f /certs/live/farout.rton.me/fullchain.pem ] && [ -f /certs/live/farout.rton.me/privkey.pem ]; then
    cat /certs/live/farout.rton.me/fullchain.pem /certs/live/farout.rton.me/privkey.pem > esmtpd.pem
    chmod 400 esmtpd.pem
    chown daemon esmtpd.pem
  else
    echo "Warning: Certificate files not found, creating dummy esmtpd.pem"
    touch esmtpd.pem
    chmod 400 esmtpd.pem
    chown daemon esmtpd.pem
  fi
)

# start the msa (courierd runs in separate container)
/usr/lib/courier/sbin/esmtpd-msa start
